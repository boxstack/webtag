@{
  Page.Title = "Dispose Item"; 

  string appDatabaseName = App.appDatabaseName;      
  var id = "";
  var tag = "";
  var po = "";
  var desc = "";
  var serno = "";
  var model = "";
  var appby = "";
  var cost = "";
  var acquired = "";
  var appdate = "";
  var dispdate = "";
  var dispby = "";
  var comments = "";

  Boolean disposed = false;

  var db = Database.Open( appDatabaseName );

  if( IsPost ) {
    Validation.Add( "dispdate",
      Validator.Required( "Please enter date formatted MM/DD/YYYY" ),
      Validator.Regex( "^([0-9]{1,2})/([0-9]{1,2})/([0-9]{2}|[0-9]{4})$" ),
      Validator.DateTime( "Enter a valid date (MM/DD/YYYY)" )
    );
    Validation.Add( "dispby",
      Validator.Required( "Name of authorized person is required" )
    );

    id = Request.Form["id"];
    tag = Request.Form["tag"];
    dispdate = Request.Form["dispdate"];
    dispby = Request.Form["dispby"].ToUpper();
    comments = Request.Form["comments"].ToUpper();

    if ( !Request["buttonDispose"].IsEmpty() && Validation.IsValid() ) {
      id = Request.Form["id"];

      var updateCommand = "UPDATE Items SET " +
                          "DisposeDate=@0, DisposeBy=@1, Comments=@2 " +
                          "WHERE ID=@3";
      db.Execute( updateCommand, dispdate, dispby, comments, id );

      Response.Redirect( "~/Items" );
    } else if ( !Request["buttonRestore"].IsEmpty() ) {
      id = Request.Form["id"];

      var updateCommand = "UPDATE Items SET " +
                          "DisposeDate=NULL, DisposeBy=NULL, Comments=NULL " +
                          "WHERE ID=@0";
      db.Execute( updateCommand, id );

      Response.Redirect( "~/Items?tag=" + tag );        
    } else {
      var dbCommand = "SELECT * FROM Items WHERE ID = @0";
      var item = db.QuerySingle( dbCommand, id );

      if ( item != null ) {
        tag = item.Tag;
        po = item.PONumber;
        desc = item.Description;
        serno = item.SerialNumber;
        model = item.Model;
        appby = item.AppliedBy;
        cost = item.Cost;

        if ( item.Acquired != null ) {
          acquired = item.Acquired.ToString( "MM/dd/yyyy" );          
        }

        if ( item.AppliedByDate != null ) {
          appdate = item.AppliedByDate.ToString( "MM/dd/yyyy" );          
        }
      }        
    }
  } else {
    if ( !Request.QueryString["id"].IsEmpty() && Request.QueryString["id"].IsInt() ){
      id = Request.QueryString["id"];

      var dbCommand = "SELECT * FROM Items WHERE ID = @0";
      var item = db.QuerySingle( dbCommand, id );

      if ( item != null ) {
        tag = item.Tag;
        po = item.PONumber;
        desc = item.Description;
        serno = item.SerialNumber;
        model = item.Model;
        appby = item.AppliedBy;
        cost = item.Cost;

        if ( item.Acquired != null ) {
          acquired = item.Acquired.ToString( "MM/dd/yyyy" );          
        }

        if ( item.AppliedByDate != null ) {
          appdate = item.AppliedByDate.ToString( "MM/dd/yyyy" );          
        }

        if ( item.DisposeDate != null ) {
          disposed = true;
          dispdate = item.DisposeDate.ToString( "MM/dd/yyyy" );
        }

        if ( disposed ) {
          Validation.AddFormError( "This Item was already disposed" );
        }

        dispby = item.DisposeBy;
        comments = item.Comments; 
      } else {
        Validation.AddFormError( "No Item was found with that ID" );
      }
    } else {
      Validation.AddFormError( "No Item was found with that ID" );
    }
  }    
}

<!-- <html> from layout -->
  <!-- <body> from layout -->
    <h2>Dispose Item</h2>
    @Html.ValidationSummary()
    <p>
      <a href="~/Items?tag=@tag">Return to Items</a>
    </p>

    <form method="post">
      <fieldset>
        <legend>Item Information</legend>

        <div>
          <span class="spanlabel">Tag:</span>
          <span class="spandata">@tag</span>
          <br />
        </div>

        <div>
          <span class="spanlabel">PO Number:</span>
          <span class="spandata">@po</span>
          <br />
        </div>

        <div>
          <span class="spanlabel">Cost:</span>
          <span class="spandata">@cost</span>
          <br />
        </div>

        <div>
          <span class="spanlabel">Acquired:</span>
          <span class="spandata">@acquired</span>
          <br />
        </div>

        <div>
          <span class="spanlabel">Description:</span>
          <span class="spandata">@desc</span>
          <br />
        </div>

        <div>
          <span class="spanlabel">Serial Number:</span>
          <span class="spandata">@serno</span>
          <br />
        </div>

        <div>
          <span class="spanlabel">Model:</span>
          <span class="spandata">@model</span>
          <br />
        </div>

        <div>
          <span class="spanlabel">Tag Applied By:</span>
          <span class="spandata">@appby</span>
          <br />
        </div>

        <div>
          <span class="spanlabel">Date Applied:</span>
          <span class="spandata">@appdate</span>
          <br />
        </div>

        <div>
          <label for="dispdate">Date Disposed:</label>
          <input type="text" name="dispdate" value="@dispdate" @Validation.For("dispdate") />
          @Html.ValidationMessage( "dispdate" )
          <br />
        </div>

        <div>
          <label for="dispby">Disposed By:</label>
          <input type="text" name="dispby" value="@dispby" @Validation.For("dispby") />
          @Html.ValidationMessage( "dispby" )
          <br />
        </div>

        <div>
          <label for="comments">Comments:</label>
          <textarea name="comments" rows="4">@comments</textarea>
          <br />
        </div>

        <input type="hidden" name="id" value="@id" />
        <input type="hidden" name="tag" value="@tag" />

        <div>
          @if ( disposed ) {
            <input type="submit" name="buttonDispose" value="Update" class="submitbutton" />
            <input type="submit" name="buttonRestore" value="Restore Item" />              
          } else {
            <input type="submit" name="buttonDispose" value="Dispose" class="submitbutton" />              
          }
        </div>
      </fieldset>
    </form>